{
  "name": "Grain Review Management v1",
  "nodes": [
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "tenant_id",
              "value": "={{ $vars.GRAIN_TENANT_ID || 'default' }}"
            },
            {
              "name": "dry_run",
              "value": "={{ $vars.GRAIN_DRY_RUN || false }}"
            },
            {
              "name": "webhook_prefix",
              "value": "={{ $vars.GRAIN_WEBHOOK_PREFIX || '/webhook' }}/{{ $workflow.name.toLowerCase().replace(/[^a-z0-9]/g, '-') }}"
            }
          ]
        },
        "options": {}
      },
      "id": "grain-config-c666onq1x",
      "name": "GRAIN_CONFIG",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [
        -200,
        -200
      ],
      "notesInFlow": true,
      "notes": "üîß Central Config"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 */4 * * *"
            }
          ]
        }
      },
      "id": "check-reviews",
      "name": "Check Reviews",
      "type": "n8n-nodes-base.scheduleTrigger",
      "position": [
        200,
        400
      ],
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://mybusiness.googleapis.com/v4/accounts/{{ $env.GBP_ACCOUNT_ID }}/locations/{{ $env.GBP_LOCATION_ID }}/reviews",
        "authentication": "oAuth2",
        "options": {}
      },
      "id": "get-google-reviews",
      "name": "Get Google Reviews",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        400,
        400
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "const reviews = $input.item.json.reviews || [];\nconst oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);\n\nconst newReviews = reviews.filter(r => {\n  const reviewDate = new Date(r.createTime);\n  return reviewDate > oneDayAgo && !r.reviewReply;\n}).map(r => ({\n  review_id: r.reviewId,\n  reviewer_name: r.reviewer?.displayName || 'Misafir',\n  rating: r.starRating === 'FIVE' ? 5 : r.starRating === 'FOUR' ? 4 : r.starRating === 'THREE' ? 3 : r.starRating === 'TWO' ? 2 : 1,\n  comment: r.comment || '',\n  create_time: r.createTime,\n  is_negative: r.starRating === 'ONE' || r.starRating === 'TWO'\n}));\n\nreturn newReviews.map(r => ({ json: r }));"
      },
      "id": "filter-new",
      "name": "Filter New Reviews",
      "type": "n8n-nodes-base.code",
      "position": [
        600,
        400
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "model": "gpt-4o-mini",
        "messages": {
          "values": [
            {
              "role": "system",
              "content": "ƒ∞≈ületme sahibi olarak yorumlara profesyonel ve samimi yanƒ±tlar yaz.\n\nPozitif (4-5 yƒ±ldƒ±z): Te≈üekk√ºr et, tekrar bekle\nNegatif (1-2 yƒ±ldƒ±z): √ñz√ºr dile, sorunu √ß√∂zmek i√ßin ileti≈üim iste\nOrta (3 yƒ±ldƒ±z): Geri bildirim i√ßin te≈üekk√ºr, iyile≈ütirme s√∂z√º ver\n\nMax 150 kelime. ƒ∞≈ületme adƒ±nƒ± kullanma, genel tut."
            },
            {
              "role": "user",
              "content": "=Reviewer: {{ $json.reviewer_name }}\nRating: {{ $json.rating }}/5\nComment: {{ $json.comment }}"
            }
          ]
        }
      },
      "id": "ai-response",
      "name": "AI Generate Response",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "position": [
        800,
        400
      ],
      "typeVersion": 1.4
    },
    {
      "parameters": {
        "conditions": {
          "conditions": [
            {
              "leftValue": "={{ $json.is_negative }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ]
        }
      },
      "id": "is-negative",
      "name": "Is Negative?",
      "type": "n8n-nodes-base.if",
      "position": [
        1000,
        400
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "channel": "#urgent-reviews",
        "text": "=üö® *Negatif Yorum Alƒ±ndƒ±!*\n\n‚≠ê Rating: {{ $json.rating }}/5\nüë§ From: {{ $json.reviewer_name }}\n\nüí¨ Yorum:\n{{ $json.comment }}\n\n‚úçÔ∏è √ñnerilen Yanƒ±t:\n{{ $('AI Generate Response').first().json.message.content }}\n\n_L√ºtfen 2 saat i√ßinde yanƒ±tlayƒ±n!_",
        "otherOptions": {}
      },
      "id": "alert-negative",
      "name": "Alert Negative",
      "type": "n8n-nodes-base.slack",
      "position": [
        1200,
        300
      ],
      "typeVersion": 2.1
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "mode": "list",
          "value": ""
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": "Review_Log"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "review_id": "={{ $json.review_id }}",
            "reviewer": "={{ $json.reviewer_name }}",
            "rating": "={{ $json.rating }}",
            "comment": "={{ $json.comment }}",
            "suggested_reply": "={{ $('AI Generate Response').first().json.message.content }}",
            "status": "pending_approval",
            "created_at": "={{ $now.toISO() }}"
          }
        }
      },
      "id": "log-review",
      "name": "Log Review",
      "type": "n8n-nodes-base.googleSheets",
      "position": [
        1200,
        500
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "content": "## üîÑ Workflow Overview\nChecks Google reviews every 4 hours, generates AI responses, and alerts on negative reviews.",
        "height": 100,
        "width": 300,
        "color": 4
      },
      "id": "note-overview",
      "name": "Note: Overview",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        180,
        250
      ]
    },
    {
      "parameters": {},
      "id": "error-trigger",
      "name": "Error Trigger",
      "type": "n8n-nodes-base.errorTrigger",
      "typeVersion": 1,
      "position": [
        600,
        650
      ]
    },
    {
      "parameters": {
        "channel": "#system-alerts",
        "text": "=üö® Review Management Error\n\nNode: {{ $json.execution.lastNodeExecuted }}\nError: {{ $json.execution.error.message }}",
        "otherOptions": {}
      },
      "id": "error-notify",
      "name": "Error Alert",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.1,
      "position": [
        800,
        650
      ]
    }
  ],
  "connections": {
    "Check Reviews": {
      "main": [
        [
          {
            "node": "Get Google Reviews",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Google Reviews": {
      "main": [
        [
          {
            "node": "Filter New Reviews",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter New Reviews": {
      "main": [
        [
          {
            "node": "AI Generate Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Generate Response": {
      "main": [
        [
          {
            "node": "Is Negative?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Negative?": {
      "main": [
        [
          {
            "node": "Alert Negative",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log Review",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Alert Negative": {
      "main": [
        [
          {
            "node": "Log Review",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "tags": [
    {
      "name": "hospitality"
    },
    {
      "name": "reviews"
    },
    {
      "name": "reputation"
    }
  ]
}