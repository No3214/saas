{
  "name": "Grain Campaign Performance Monitor v1",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 4
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Every 4 Hours",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [250, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://analyticsdata.googleapis.com/v1beta/properties/{{ $vars.GA4_PROPERTY_ID }}:runReport",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googleApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"dateRanges\": [\n    { \"startDate\": \"7daysAgo\", \"endDate\": \"today\" },\n    { \"startDate\": \"14daysAgo\", \"endDate\": \"8daysAgo\" }\n  ],\n  \"metrics\": [\n    { \"name\": \"sessions\" },\n    { \"name\": \"totalUsers\" },\n    { \"name\": \"newUsers\" },\n    { \"name\": \"engagementRate\" },\n    { \"name\": \"conversions\" },\n    { \"name\": \"purchaseRevenue\" },\n    { \"name\": \"averageSessionDuration\" }\n  ],\n  \"dimensions\": [\n    { \"name\": \"sessionDefaultChannelGroup\" },\n    { \"name\": \"sessionCampaignName\" }\n  ]\n}",
        "options": {}
      },
      "id": "fetch-ga4-data",
      "name": "Fetch GA4 Data",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [500, 200],
      "credentials": {
        "googleApi": {
          "id": "google-analytics-credential",
          "name": "Google Analytics OAuth2"
        }
      }
    },
    {
      "parameters": {
        "method": "GET",
        "url": "https://googleads.googleapis.com/v17/customers/{{ $vars.GOOGLE_ADS_CUSTOMER_ID }}/googleAds:search",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googleAdsOAuth2Api",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "SELECT campaign.name, campaign.id, campaign.status, metrics.impressions, metrics.clicks, metrics.cost_micros, metrics.conversions, metrics.conversions_value, metrics.ctr, metrics.average_cpc FROM campaign WHERE segments.date DURING LAST_7_DAYS"
            }
          ]
        },
        "options": {}
      },
      "id": "fetch-google-ads",
      "name": "Fetch Google Ads",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [500, 400],
      "credentials": {
        "googleAdsOAuth2Api": {
          "id": "google-ads-credential",
          "name": "Google Ads OAuth2"
        }
      }
    },
    {
      "parameters": {
        "method": "GET",
        "url": "https://graph.facebook.com/v19.0/act_{{ $vars.META_AD_ACCOUNT_ID }}/insights",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "facebookGraphApi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "fields",
              "value": "campaign_name,campaign_id,impressions,clicks,spend,reach,cpm,cpc,ctr,actions,cost_per_action_type,purchase_roas"
            },
            {
              "name": "date_preset",
              "value": "last_7d"
            },
            {
              "name": "level",
              "value": "campaign"
            }
          ]
        },
        "options": {}
      },
      "id": "fetch-meta-ads",
      "name": "Fetch Meta Ads",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [500, 600],
      "credentials": {
        "facebookGraphApi": {
          "id": "meta-ads-credential",
          "name": "Meta Ads API"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.linkedin.com/v2/adAnalyticsV2",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "linkedInOAuth2Api",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "q",
              "value": "analytics"
            },
            {
              "name": "dateRange.start.day",
              "value": "={{ $now.minus({ days: 7 }).day }}"
            },
            {
              "name": "dateRange.start.month",
              "value": "={{ $now.minus({ days: 7 }).month }}"
            },
            {
              "name": "dateRange.start.year",
              "value": "={{ $now.minus({ days: 7 }).year }}"
            },
            {
              "name": "dateRange.end.day",
              "value": "={{ $now.day }}"
            },
            {
              "name": "dateRange.end.month",
              "value": "={{ $now.month }}"
            },
            {
              "name": "dateRange.end.year",
              "value": "={{ $now.year }}"
            },
            {
              "name": "campaigns",
              "value": "={{ $vars.LINKEDIN_CAMPAIGNS }}"
            },
            {
              "name": "fields",
              "value": "impressions,clicks,costInLocalCurrency,conversions,conversionValueInLocalCurrency"
            }
          ]
        },
        "options": {}
      },
      "id": "fetch-linkedin-ads",
      "name": "Fetch LinkedIn Ads",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [500, 800],
      "credentials": {
        "linkedInOAuth2Api": {
          "id": "linkedin-ads-credential",
          "name": "LinkedIn Ads OAuth2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Aggregate and normalize campaign data from all platforms\nconst ga4Data = $('Fetch GA4 Data').first().json;\nconst googleAds = $('Fetch Google Ads').first().json;\nconst metaAds = $('Fetch Meta Ads').first().json;\nconst linkedInAds = $('Fetch LinkedIn Ads').first().json;\n\nconst campaigns = [];\n\n// Process Google Ads\nif (googleAds.results) {\n  googleAds.results.forEach(row => {\n    const campaign = row.campaign;\n    const metrics = row.metrics;\n    campaigns.push({\n      platform: 'Google Ads',\n      campaignId: campaign.id,\n      campaignName: campaign.name,\n      status: campaign.status,\n      impressions: parseInt(metrics.impressions) || 0,\n      clicks: parseInt(metrics.clicks) || 0,\n      spend: (parseInt(metrics.cost_micros) || 0) / 1000000,\n      conversions: parseFloat(metrics.conversions) || 0,\n      revenue: parseFloat(metrics.conversions_value) || 0,\n      ctr: parseFloat(metrics.ctr) || 0,\n      cpc: (parseInt(metrics.average_cpc) || 0) / 1000000,\n      roas: metrics.conversions_value && metrics.cost_micros ? \n        (metrics.conversions_value / (metrics.cost_micros / 1000000)).toFixed(2) : 0\n    });\n  });\n}\n\n// Process Meta Ads\nif (metaAds.data) {\n  metaAds.data.forEach(row => {\n    const conversions = row.actions?.find(a => a.action_type === 'purchase')?.value || 0;\n    const revenue = row.actions?.find(a => a.action_type === 'omni_purchase')?.value || 0;\n    campaigns.push({\n      platform: 'Meta Ads',\n      campaignId: row.campaign_id,\n      campaignName: row.campaign_name,\n      status: 'ENABLED',\n      impressions: parseInt(row.impressions) || 0,\n      clicks: parseInt(row.clicks) || 0,\n      spend: parseFloat(row.spend) || 0,\n      conversions: parseInt(conversions),\n      revenue: parseFloat(revenue) || 0,\n      ctr: parseFloat(row.ctr) || 0,\n      cpc: parseFloat(row.cpc) || 0,\n      roas: row.purchase_roas?.[0]?.value || 0,\n      reach: parseInt(row.reach) || 0,\n      cpm: parseFloat(row.cpm) || 0\n    });\n  });\n}\n\n// Process LinkedIn Ads\nif (linkedInAds.elements) {\n  linkedInAds.elements.forEach(row => {\n    campaigns.push({\n      platform: 'LinkedIn Ads',\n      campaignId: row.pivotValue,\n      campaignName: row.campaignName || `Campaign ${row.pivotValue}`,\n      status: 'ENABLED',\n      impressions: parseInt(row.impressions) || 0,\n      clicks: parseInt(row.clicks) || 0,\n      spend: parseFloat(row.costInLocalCurrency) || 0,\n      conversions: parseInt(row.conversions) || 0,\n      revenue: parseFloat(row.conversionValueInLocalCurrency) || 0,\n      ctr: row.impressions > 0 ? ((row.clicks / row.impressions) * 100).toFixed(2) : 0,\n      cpc: row.clicks > 0 ? (row.costInLocalCurrency / row.clicks).toFixed(2) : 0,\n      roas: row.costInLocalCurrency > 0 ? \n        (row.conversionValueInLocalCurrency / row.costInLocalCurrency).toFixed(2) : 0\n    });\n  });\n}\n\n// Calculate platform totals\nconst platformTotals = {};\ncampaigns.forEach(c => {\n  if (!platformTotals[c.platform]) {\n    platformTotals[c.platform] = {\n      campaigns: 0,\n      impressions: 0,\n      clicks: 0,\n      spend: 0,\n      conversions: 0,\n      revenue: 0\n    };\n  }\n  platformTotals[c.platform].campaigns++;\n  platformTotals[c.platform].impressions += c.impressions;\n  platformTotals[c.platform].clicks += c.clicks;\n  platformTotals[c.platform].spend += c.spend;\n  platformTotals[c.platform].conversions += c.conversions;\n  platformTotals[c.platform].revenue += c.revenue;\n});\n\n// Calculate derived metrics for totals\nObject.keys(platformTotals).forEach(platform => {\n  const p = platformTotals[platform];\n  p.ctr = p.impressions > 0 ? ((p.clicks / p.impressions) * 100).toFixed(2) : 0;\n  p.cpc = p.clicks > 0 ? (p.spend / p.clicks).toFixed(2) : 0;\n  p.cpa = p.conversions > 0 ? (p.spend / p.conversions).toFixed(2) : 0;\n  p.roas = p.spend > 0 ? (p.revenue / p.spend).toFixed(2) : 0;\n});\n\n// Overall totals\nconst overall = {\n  totalSpend: campaigns.reduce((sum, c) => sum + c.spend, 0),\n  totalRevenue: campaigns.reduce((sum, c) => sum + c.revenue, 0),\n  totalConversions: campaigns.reduce((sum, c) => sum + c.conversions, 0),\n  totalImpressions: campaigns.reduce((sum, c) => sum + c.impressions, 0),\n  totalClicks: campaigns.reduce((sum, c) => sum + c.clicks, 0),\n  activeCampaigns: campaigns.filter(c => c.status === 'ENABLED').length\n};\noverall.blendedRoas = overall.totalSpend > 0 ? (overall.totalRevenue / overall.totalSpend).toFixed(2) : 0;\noverall.blendedCpa = overall.totalConversions > 0 ? (overall.totalSpend / overall.totalConversions).toFixed(2) : 0;\n\nreturn [{\n  json: {\n    campaigns,\n    platformTotals,\n    overall,\n    reportDate: new Date().toISOString(),\n    period: 'Last 7 Days'\n  }\n}];"
      },
      "id": "aggregate-campaigns",
      "name": "Aggregate Campaign Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [800, 500]
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o",
          "mode": "list",
          "cachedResultName": "GPT-4O"
        },
        "messages": {
          "values": [
            {
              "content": "You are a digital marketing analyst AI. Analyze campaign performance data and provide actionable insights.\n\nFocus on:\n1. Performance trends and anomalies\n2. Budget optimization opportunities\n3. Underperforming campaigns that need attention\n4. High-performing campaigns to scale\n5. Platform-specific recommendations\n6. ROAS optimization strategies\n\nProvide specific, data-driven recommendations.",
              "role": "system"
            },
            {
              "content": "=Analyze this campaign performance data:\n\n**Overall Summary:**\n- Total Spend: ${{ $json.overall.totalSpend.toFixed(2) }}\n- Total Revenue: ${{ $json.overall.totalRevenue.toFixed(2) }}\n- Total Conversions: {{ $json.overall.totalConversions }}\n- Blended ROAS: {{ $json.overall.blendedRoas }}x\n- Blended CPA: ${{ $json.overall.blendedCpa }}\n\n**Platform Breakdown:**\n{{ JSON.stringify($json.platformTotals, null, 2) }}\n\n**Campaign Details:**\n{{ JSON.stringify($json.campaigns.slice(0, 20), null, 2) }}\n\nProvide:\n1. Executive summary (2-3 sentences)\n2. Top 3 opportunities to improve ROAS\n3. Top 3 concerns/risks\n4. Specific campaign recommendations\n5. Budget reallocation suggestions",
              "role": "user"
            }
          ]
        },
        "options": {
          "temperature": 0.4,
          "maxTokens": 2000
        }
      },
      "id": "ai-analysis",
      "name": "AI Performance Analysis",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [1050, 400],
      "credentials": {
        "openAiApi": {
          "id": "openai-credential",
          "name": "OpenAI API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Identify campaigns needing immediate attention\nconst data = $('Aggregate Campaign Data').first().json;\nconst campaigns = data.campaigns;\n\n// Define thresholds for alerts\nconst alerts = [];\n\ncampaigns.forEach(c => {\n  // High spend, low ROAS\n  if (c.spend > 500 && parseFloat(c.roas) < 1) {\n    alerts.push({\n      type: 'low_roas',\n      severity: 'high',\n      platform: c.platform,\n      campaign: c.campaignName,\n      message: `ROAS ${c.roas}x with $${c.spend.toFixed(2)} spend`,\n      recommendation: 'Consider pausing or optimizing targeting'\n    });\n  }\n  \n  // High CPA compared to benchmark\n  const cpaBenchmark = 50; // Adjust based on client\n  if (c.conversions > 0 && (c.spend / c.conversions) > cpaBenchmark * 1.5) {\n    alerts.push({\n      type: 'high_cpa',\n      severity: 'medium',\n      platform: c.platform,\n      campaign: c.campaignName,\n      message: `CPA $${(c.spend / c.conversions).toFixed(2)} exceeds benchmark`,\n      recommendation: 'Review audience targeting and creative performance'\n    });\n  }\n  \n  // Low CTR (potential ad fatigue)\n  if (c.impressions > 10000 && parseFloat(c.ctr) < 0.5) {\n    alerts.push({\n      type: 'low_ctr',\n      severity: 'medium',\n      platform: c.platform,\n      campaign: c.campaignName,\n      message: `CTR ${c.ctr}% indicates potential ad fatigue`,\n      recommendation: 'Refresh creative or adjust targeting'\n    });\n  }\n  \n  // No conversions with significant spend\n  if (c.spend > 200 && c.conversions === 0) {\n    alerts.push({\n      type: 'no_conversions',\n      severity: 'high',\n      platform: c.platform,\n      campaign: c.campaignName,\n      message: `$${c.spend.toFixed(2)} spent with zero conversions`,\n      recommendation: 'Pause campaign and investigate tracking/funnel'\n    });\n  }\n});\n\n// Sort by severity\nalerts.sort((a, b) => {\n  const severityOrder = { high: 0, medium: 1, low: 2 };\n  return severityOrder[a.severity] - severityOrder[b.severity];\n});\n\nreturn [{ json: { alerts, count: alerts.length } }];"
      },
      "id": "identify-alerts",
      "name": "Identify Alerts",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1050, 600]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-high-alerts",
              "leftValue": "={{ $json.alerts.filter(a => a.severity === 'high').length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-urgent-alerts",
      "name": "Has Urgent Alerts?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1300, 600]
    },
    {
      "parameters": {
        "channel": "={{ $vars.MARKETING_SLACK_CHANNEL }}",
        "text": "=üö® *URGENT: Campaign Performance Alert*\n\n{{ $json.alerts.filter(a => a.severity === 'high').map(a => `*${a.platform} - ${a.campaign}*\n‚ö†Ô∏è ${a.message}\nüí° ${a.recommendation}`).join('\\n\\n') }}\n\n_Immediate attention required_",
        "otherOptions": {
          "mrkdwn": true
        }
      },
      "id": "alert-urgent",
      "name": "Send Urgent Alert",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.2,
      "position": [1550, 500],
      "credentials": {
        "slackApi": {
          "id": "slack-credential",
          "name": "Slack API"
        }
      }
    },
    {
      "parameters": {
        "channel": "={{ $vars.MARKETING_SLACK_CHANNEL }}",
        "text": "=üìä *Campaign Performance Report - {{ $now.format('MMMM d, yyyy') }}*\n\n*Overall Performance (Last 7 Days):*\n‚Ä¢ Total Spend: ${{ $('Aggregate Campaign Data').first().json.overall.totalSpend.toFixed(2) }}\n‚Ä¢ Total Revenue: ${{ $('Aggregate Campaign Data').first().json.overall.totalRevenue.toFixed(2) }}\n‚Ä¢ Blended ROAS: {{ $('Aggregate Campaign Data').first().json.overall.blendedRoas }}x\n‚Ä¢ Total Conversions: {{ $('Aggregate Campaign Data').first().json.overall.totalConversions }}\n‚Ä¢ Blended CPA: ${{ $('Aggregate Campaign Data').first().json.overall.blendedCpa }}\n\n*Platform Summary:*\n{{ Object.entries($('Aggregate Campaign Data').first().json.platformTotals).map(([platform, data]) => `‚Ä¢ *${platform}*: $${data.spend.toFixed(2)} spend | ${data.conversions} conv | ${data.roas}x ROAS`).join('\\n') }}\n\n*AI Analysis:*\n{{ $('AI Performance Analysis').first().json.message?.content || $('AI Performance Analysis').first().json.choices?.[0]?.message?.content || 'Analysis pending' }}\n\n{{ $('Identify Alerts').first().json.count > 0 ? `‚ö†Ô∏è *${$('Identify Alerts').first().json.count} alerts require attention*` : '‚úÖ No critical alerts' }}",
        "otherOptions": {}
      },
      "id": "send-report",
      "name": "Send Daily Report",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.2,
      "position": [1550, 700],
      "credentials": {
        "slackApi": {
          "id": "slack-credential",
          "name": "Slack API"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "={{ $vars.CAMPAIGN_LOG_SHEET_ID }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "Performance Log",
          "mode": "list",
          "cachedResultName": "Performance Log"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Date": "={{ $now.format('yyyy-MM-dd HH:mm') }}",
            "Total Spend": "={{ $('Aggregate Campaign Data').first().json.overall.totalSpend.toFixed(2) }}",
            "Total Revenue": "={{ $('Aggregate Campaign Data').first().json.overall.totalRevenue.toFixed(2) }}",
            "Blended ROAS": "={{ $('Aggregate Campaign Data').first().json.overall.blendedRoas }}",
            "Total Conversions": "={{ $('Aggregate Campaign Data').first().json.overall.totalConversions }}",
            "Blended CPA": "={{ $('Aggregate Campaign Data').first().json.overall.blendedCpa }}",
            "Active Campaigns": "={{ $('Aggregate Campaign Data').first().json.overall.activeCampaigns }}",
            "Alerts": "={{ $('Identify Alerts').first().json.count }}"
          }
        },
        "options": {}
      },
      "id": "log-performance",
      "name": "Log Performance Data",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [1550, 900],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "google-sheets-credential",
          "name": "Google Sheets OAuth2"
        }
      }
    }
  ],
  "connections": {
    "Every 4 Hours": {
      "main": [
        [
          { "node": "Fetch GA4 Data", "type": "main", "index": 0 },
          { "node": "Fetch Google Ads", "type": "main", "index": 0 },
          { "node": "Fetch Meta Ads", "type": "main", "index": 0 },
          { "node": "Fetch LinkedIn Ads", "type": "main", "index": 0 }
        ]
      ]
    },
    "Fetch GA4 Data": {
      "main": [
        [{ "node": "Aggregate Campaign Data", "type": "main", "index": 0 }]
      ]
    },
    "Fetch Google Ads": {
      "main": [
        [{ "node": "Aggregate Campaign Data", "type": "main", "index": 0 }]
      ]
    },
    "Fetch Meta Ads": {
      "main": [
        [{ "node": "Aggregate Campaign Data", "type": "main", "index": 0 }]
      ]
    },
    "Fetch LinkedIn Ads": {
      "main": [
        [{ "node": "Aggregate Campaign Data", "type": "main", "index": 0 }]
      ]
    },
    "Aggregate Campaign Data": {
      "main": [
        [
          { "node": "AI Performance Analysis", "type": "main", "index": 0 },
          { "node": "Identify Alerts", "type": "main", "index": 0 }
        ]
      ]
    },
    "AI Performance Analysis": {
      "main": [
        [{ "node": "Send Daily Report", "type": "main", "index": 0 }]
      ]
    },
    "Identify Alerts": {
      "main": [
        [{ "node": "Has Urgent Alerts?", "type": "main", "index": 0 }]
      ]
    },
    "Has Urgent Alerts?": {
      "main": [
        [{ "node": "Send Urgent Alert", "type": "main", "index": 0 }],
        []
      ]
    },
    "Send Urgent Alert": {
      "main": [
        [{ "node": "Send Daily Report", "type": "main", "index": 0 }]
      ]
    },
    "Send Daily Report": {
      "main": [
        [{ "node": "Log Performance Data", "type": "main", "index": 0 }]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    { "id": "agency", "name": "agency" },
    { "id": "marketing", "name": "marketing" },
    { "id": "analytics", "name": "analytics" },
    { "id": "automation", "name": "automation" }
  ],
  "triggerCount": 1,
  "updatedAt": "2026-01-07T00:00:00.000Z",
  "versionId": "1"
}
