{
  "name": "Grain Trendyol Stock Manager v1",
  "nodes": [
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "tenant_id",
              "value": "={{ $vars.GRAIN_TENANT_ID || 'default' }}"
            },
            {
              "name": "trendyol_seller_id",
              "value": "={{ $vars.TRENDYOL_SELLER_ID }}"
            },
            {
              "name": "low_stock_threshold",
              "value": "={{ $vars.LOW_STOCK_THRESHOLD || 10 }}"
            },
            {
              "name": "critical_stock_threshold",
              "value": "={{ $vars.CRITICAL_STOCK_THRESHOLD || 3 }}"
            }
          ]
        },
        "options": {}
      },
      "id": "grain-config",
      "name": "GRAIN_CONFIG",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [-200, 0],
      "notesInFlow": true,
      "notes": "ðŸ”§ Stock Manager Config"
    },
    {
      "parameters": {
        "content": "## ðŸ“¦ Trendyol Stock Manager v1\n\n**Features:**\n- Stok senkronizasyonu (Trendyol â†” DB)\n- DÃ¼ÅŸÃ¼k stok uyarÄ±larÄ±\n- Toplu stok gÃ¼ncelleme\n- Fiyat senkronizasyonu\n- GÃ¼nlÃ¼k stok raporu\n\n**Sync:** Her 15 dakikada bir",
        "height": 180,
        "width": 350,
        "color": 5
      },
      "id": "note-overview",
      "name": "Overview",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [60, -100]
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 15
            }
          ]
        }
      },
      "id": "schedule-sync",
      "name": "Her 15 Dakika",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [100, 200]
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "triggerAtHour": 9
            }
          ]
        }
      },
      "id": "daily-report",
      "name": "GÃ¼nlÃ¼k Rapor (09:00)",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [100, 600]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "trendyol/stock-update",
        "options": {
          "responseMode": "responseNode"
        }
      },
      "id": "webhook-manual",
      "name": "Manuel GÃ¼ncelleme",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [100, 400],
      "webhookId": "trendyol-stock"
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://api.trendyol.com/sapigw/suppliers/{{ $node.GRAIN_CONFIG.json.trendyol_seller_id }}/products",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "approved",
              "value": "true"
            },
            {
              "name": "size",
              "value": "200"
            }
          ]
        },
        "options": {}
      },
      "id": "get-trendyol-products",
      "name": "Trendyol ÃœrÃ¼nleri Al",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [350, 200],
      "credentials": {
        "httpBasicAuth": {
          "id": "trendyol-api",
          "name": "Trendyol API"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT barcode, product_name, stock, price, last_sync FROM products WHERE source = 'trendyol' OR marketplace = 'trendyol'",
        "options": {}
      },
      "id": "get-local-products",
      "name": "Yerel ÃœrÃ¼nleri Al",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [350, 400],
      "credentials": {
        "postgres": {
          "id": "postgres-main",
          "name": "PostgreSQL Main"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Trendyol Ã¼rÃ¼nlerini parse et\nconst response = $input.item.json;\nconst products = response.content || [];\n\nreturn products.map(p => ({\n  json: {\n    barcode: p.barcode,\n    productId: p.id,\n    title: p.title,\n    trendyol_stock: p.quantity,\n    trendyol_price: p.salePrice,\n    listPrice: p.listPrice,\n    brand: p.brand,\n    categoryName: p.categoryName,\n    approved: p.approved,\n    onSale: p.onSale\n  }\n}));"
      },
      "id": "parse-trendyol",
      "name": "Parse Trendyol",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [600, 200]
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByKey",
        "mergeByFields": {
          "values": [
            {
              "field1": "barcode",
              "field2": "barcode"
            }
          ]
        },
        "joinMode": "enrichInput1",
        "options": {}
      },
      "id": "compare-stock",
      "name": "Stok KarÅŸÄ±laÅŸtÄ±r",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [850, 300]
    },
    {
      "parameters": {
        "jsCode": "// Stok farklÄ±lÄ±klarÄ±nÄ± bul\nconst items = $input.all();\nconst differences = [];\n\nfor (const item of items) {\n  const data = item.json;\n  const trendyolStock = data.trendyol_stock || 0;\n  const localStock = data.stock || 0;\n  \n  if (trendyolStock !== localStock) {\n    differences.push({\n      json: {\n        barcode: data.barcode,\n        productName: data.title || data.product_name,\n        trendyol_stock: trendyolStock,\n        local_stock: localStock,\n        difference: localStock - trendyolStock,\n        action: localStock > trendyolStock ? 'increase' : 'decrease',\n        needs_update: true\n      }\n    });\n  }\n}\n\nif (differences.length === 0) {\n  return [{ json: { message: 'TÃ¼m stoklar senkron', needs_update: false } }];\n}\n\nreturn differences;"
      },
      "id": "find-differences",
      "name": "FarklarÄ± Bul",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1100, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "needs-update",
              "leftValue": "={{ $json.needs_update }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "filter-updates",
      "name": "GÃ¼ncelleme Gerekli?",
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2,
      "position": [1350, 300]
    },
    {
      "parameters": {
        "jsCode": "// Trendyol API iÃ§in stok gÃ¼ncelleme payload hazÄ±rla\nconst items = $input.all();\nconst updateItems = items.map(item => ({\n  barcode: item.json.barcode,\n  quantity: item.json.local_stock,\n  salePrice: item.json.price || item.json.trendyol_price,\n  listPrice: item.json.listPrice\n}));\n\nreturn {\n  json: {\n    items: updateItems,\n    count: updateItems.length\n  }\n};"
      },
      "id": "prepare-update-payload",
      "name": "Update Payload HazÄ±rla",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1600, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.trendyol.com/sapigw/suppliers/{{ $node.GRAIN_CONFIG.json.trendyol_seller_id }}/products/price-and-inventory",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ items: $json.items }) }}",
        "options": {}
      },
      "id": "update-trendyol",
      "name": "Trendyol'u GÃ¼ncelle",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1850, 200],
      "credentials": {
        "httpBasicAuth": {
          "id": "trendyol-api",
          "name": "Trendyol API"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "low-stock",
              "leftValue": "={{ $json.local_stock }}",
              "rightValue": "={{ $node.GRAIN_CONFIG.json.low_stock_threshold }}",
              "operator": {
                "type": "number",
                "operation": "lte"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-low-stock",
      "name": "DÃ¼ÅŸÃ¼k Stok?",
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2,
      "position": [1350, 500]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "critical",
              "leftValue": "={{ $json.local_stock }}",
              "rightValue": "={{ $node.GRAIN_CONFIG.json.critical_stock_threshold }}",
              "operator": {
                "type": "number",
                "operation": "lte"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-critical",
      "name": "Kritik Stok?",
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2,
      "position": [1600, 500]
    },
    {
      "parameters": {
        "channel": "#stok-uyarilari",
        "text": "=ðŸ”´ *KRÄ°TÄ°K STOK UYARISI*\n\nÃœrÃ¼n: {{ $json.productName }}\nBarkod: {{ $json.barcode }}\nKalan: *{{ $json.local_stock }} adet*\n\nâš¡ ACÄ°L TEDARÄ°K GEREKLÄ°!",
        "otherOptions": {}
      },
      "id": "critical-alert",
      "name": "Kritik UyarÄ±",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.2,
      "position": [1850, 500],
      "credentials": {
        "slackApi": {
          "id": "slack-main",
          "name": "Slack"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  COUNT(*) as total_products,\n  SUM(CASE WHEN stock <= 3 THEN 1 ELSE 0 END) as critical_count,\n  SUM(CASE WHEN stock <= 10 AND stock > 3 THEN 1 ELSE 0 END) as low_count,\n  SUM(CASE WHEN stock > 10 THEN 1 ELSE 0 END) as healthy_count,\n  SUM(stock) as total_stock,\n  AVG(stock)::int as avg_stock\nFROM products WHERE marketplace = 'trendyol'",
        "options": {}
      },
      "id": "get-stats",
      "name": "Stok Ä°statistikleri",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [350, 600],
      "credentials": {
        "postgres": {
          "id": "postgres-main",
          "name": "PostgreSQL Main"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT barcode, product_name, stock FROM products WHERE marketplace = 'trendyol' AND stock <= 10 ORDER BY stock ASC LIMIT 20",
        "options": {}
      },
      "id": "get-low-stock-list",
      "name": "DÃ¼ÅŸÃ¼k Stok Listesi",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [600, 600],
      "credentials": {
        "postgres": {
          "id": "postgres-main",
          "name": "PostgreSQL Main"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// GÃ¼nlÃ¼k rapor oluÅŸtur\nconst stats = $('Stok Ä°statistikleri').first().json;\nconst lowStockItems = $('DÃ¼ÅŸÃ¼k Stok Listesi').all();\n\nconst today = new Date().toLocaleDateString('tr-TR', {\n  weekday: 'long',\n  year: 'numeric',\n  month: 'long',\n  day: 'numeric'\n});\n\nlet lowStockText = '';\nif (lowStockItems.length > 0) {\n  lowStockText = '\\n\\nðŸ“‹ *DÃ¼ÅŸÃ¼k Stoklu ÃœrÃ¼nler:*\\n';\n  lowStockItems.forEach((item, i) => {\n    lowStockText += `${i+1}. ${item.json.product_name} - *${item.json.stock} adet*\\n`;\n  });\n}\n\nreturn {\n  json: {\n    report: `ðŸ“Š *Trendyol GÃ¼nlÃ¼k Stok Raporu*\\n${today}\\n\\n` +\n      `ðŸª Toplam ÃœrÃ¼n: ${stats.total_products}\\n` +\n      `ðŸ“¦ Toplam Stok: ${stats.total_stock} adet\\n` +\n      `ðŸ“ˆ Ortalama Stok: ${stats.avg_stock} adet/Ã¼rÃ¼n\\n\\n` +\n      `âœ… SaÄŸlÄ±klÄ±: ${stats.healthy_count}\\n` +\n      `âš ï¸ DÃ¼ÅŸÃ¼k: ${stats.low_count}\\n` +\n      `ðŸ”´ Kritik: ${stats.critical_count}` +\n      lowStockText,\n    stats: stats,\n    lowStockCount: lowStockItems.length\n  }\n};"
      },
      "id": "generate-report",
      "name": "Rapor OluÅŸtur",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [850, 600]
    },
    {
      "parameters": {
        "channel": "#trendyol-raporlar",
        "text": "={{ $json.report }}",
        "otherOptions": {}
      },
      "id": "send-daily-report",
      "name": "GÃ¼nlÃ¼k Rapor GÃ¶nder",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.2,
      "position": [1100, 600],
      "credentials": {
        "slackApi": {
          "id": "slack-main",
          "name": "Slack"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE products SET last_sync = NOW() WHERE barcode IN ({{ $json.items.map(i => `'${i.barcode}'`).join(',') }})",
        "options": {}
      },
      "id": "update-sync-time",
      "name": "Sync ZamanÄ± GÃ¼ncelle",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [2100, 200],
      "credentials": {
        "postgres": {
          "id": "postgres-main",
          "name": "PostgreSQL Main"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, updated: $json.count, timestamp: new Date().toISOString() }) }}"
      },
      "id": "webhook-response",
      "name": "Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [2100, 400]
    },
    {
      "parameters": {},
      "id": "error-trigger",
      "name": "Error Trigger",
      "type": "n8n-nodes-base.errorTrigger",
      "typeVersion": 1,
      "position": [1600, 750]
    },
    {
      "parameters": {
        "channel": "#trendyol-hatalar",
        "text": "=ðŸš¨ *Stock Manager HatasÄ±*\n\nWorkflow: {{ $workflow.name }}\nHata: {{ $json.execution.error.message }}\nZaman: {{ new Date().toLocaleString('tr-TR') }}",
        "otherOptions": {}
      },
      "id": "error-notify",
      "name": "Hata Bildirimi",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.2,
      "position": [1850, 750],
      "credentials": {
        "slackApi": {
          "id": "slack-main",
          "name": "Slack"
        }
      }
    }
  ],
  "connections": {
    "Her 15 Dakika": {
      "main": [
        [
          {
            "node": "Trendyol ÃœrÃ¼nleri Al",
            "type": "main",
            "index": 0
          },
          {
            "node": "Yerel ÃœrÃ¼nleri Al",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manuel GÃ¼ncelleme": {
      "main": [
        [
          {
            "node": "Trendyol ÃœrÃ¼nleri Al",
            "type": "main",
            "index": 0
          },
          {
            "node": "Yerel ÃœrÃ¼nleri Al",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trendyol ÃœrÃ¼nleri Al": {
      "main": [
        [
          {
            "node": "Parse Trendyol",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Trendyol": {
      "main": [
        [
          {
            "node": "Stok KarÅŸÄ±laÅŸtÄ±r",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Yerel ÃœrÃ¼nleri Al": {
      "main": [
        [
          {
            "node": "Stok KarÅŸÄ±laÅŸtÄ±r",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Stok KarÅŸÄ±laÅŸtÄ±r": {
      "main": [
        [
          {
            "node": "FarklarÄ± Bul",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FarklarÄ± Bul": {
      "main": [
        [
          {
            "node": "GÃ¼ncelleme Gerekli?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GÃ¼ncelleme Gerekli?": {
      "main": [
        [
          {
            "node": "Update Payload HazÄ±rla",
            "type": "main",
            "index": 0
          },
          {
            "node": "DÃ¼ÅŸÃ¼k Stok?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Payload HazÄ±rla": {
      "main": [
        [
          {
            "node": "Trendyol'u GÃ¼ncelle",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trendyol'u GÃ¼ncelle": {
      "main": [
        [
          {
            "node": "Sync ZamanÄ± GÃ¼ncelle",
            "type": "main",
            "index": 0
          },
          {
            "node": "Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DÃ¼ÅŸÃ¼k Stok?": {
      "main": [
        [
          {
            "node": "Kritik Stok?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Kritik Stok?": {
      "main": [
        [
          {
            "node": "Kritik UyarÄ±",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GÃ¼nlÃ¼k Rapor (09:00)": {
      "main": [
        [
          {
            "node": "Stok Ä°statistikleri",
            "type": "main",
            "index": 0
          },
          {
            "node": "DÃ¼ÅŸÃ¼k Stok Listesi",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Stok Ä°statistikleri": {
      "main": [
        [
          {
            "node": "Rapor OluÅŸtur",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DÃ¼ÅŸÃ¼k Stok Listesi": {
      "main": [
        [
          {
            "node": "Rapor OluÅŸtur",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Rapor OluÅŸtur": {
      "main": [
        [
          {
            "node": "GÃ¼nlÃ¼k Rapor GÃ¶nder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Error Trigger": {
      "main": [
        [
          {
            "node": "Hata Bildirimi",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  },
  "meta": {
    "grain_module": "ecommerce",
    "grain_tier": "Critical",
    "grain_version": "1.0.0",
    "grain_language": "tr",
    "grain_description": "Trendyol stok yÃ¶netimi - senkronizasyon, uyarÄ±lar, raporlama",
    "grain_features": [
      "Trendyol API stok senkronizasyonu",
      "DÃ¼ÅŸÃ¼k/kritik stok uyarÄ±larÄ±",
      "Otomatik Trendyol gÃ¼ncelleme",
      "GÃ¼nlÃ¼k stok raporu",
      "Manuel webhook tetikleme",
      "PostgreSQL entegrasyonu"
    ],
    "grain_dependencies": [
      "PostgreSQL",
      "Slack",
      "Trendyol API"
    ]
  }
}
